rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
  
    // Helper function to check if a user is an admin by reading their Firestore document.
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Product Images: Publicly readable, only admins can write/delete.
    // Max size: 1MB
    match /product-images/{productId}/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() &&
                      request.resource.size < 1 * 1024 * 1024 &&
                      request.resource.contentType.matches('image/.*');
    }

    // Category Images: Publicly readable, only admins can write/delete.
    // Max size: 1MB
    match /category-images/{categoryId}/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin() &&
                      request.resource.size < 1 * 1024 * 1024 &&
                      request.resource.contentType.matches('image/.*');
    }

    // Site Assets (e.g., social preview image): Publicly readable, only admins can write/delete.
    // Max size: 2MB
    match /site-assets/{fileName} {
       allow read: if true;
       allow write: if isAdmin() &&
                       request.resource.size < 2 * 1024 * 1024 &&
                       request.resource.contentType.matches('image/.*');
    }

    // User Avatars: Publicly readable. Only the authenticated user who owns the avatar can write it.
    // Max size: 1MB
    match /avatars/{userId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size < 1 * 1024 * 1024 &&
                      request.resource.contentType.matches('image/.*');
    }

    // User Shared Files: Not publicly readable. Admins can create/read/delete.
    // The logic for users to access these is handled by generating a download URL, not direct reads.
    // Max size: 1MB
    match /userSharedFiles/{phoneNumber}/{fileName} {
        allow read, write: if isAdmin() &&
                              request.resource.size < 1 * 1024 * 1024 &&
                              request.resource.contentType.matches('image/.*|application/pdf');
    }
  }
}